[toc]

* **批量删除pv**

~~~shell

# 注意工作空间
for line in  $(kubectl get pvc -n dgis-server | grep "modeling" | awk ' NR > 1{print $1}') ;do  kubectl delete pvc  $line  -n dgis-server ; echo $line; done



for line in  $(kubectl get pv -n dgis-server | grep "modeling" | awk ' NR > 1{print $1}') ;do  kubectl delete pv  $line  -n dgis-server ; echo $line; done
~~~

* 私有仓库配置

  * 配置密码

    ~~~shell
    htpasswd -Bbn admin qdfsdFGC > ./httppasswd
    ~~~

  * k8s 创建 secret

    ~~~shell
    kubectl create secret docker-registry regsecret --docker-server=https://registry.dgisserver.com:5000 --docker-username=admin --docker-password=qdfsdFGC -n dgis-server
    ~~~

  * docker registry deploymet

    ~~~yam
    kind: Deployment
    apiVersion: apps/v1
    metadata:
      name: dgis-docker-hub
      namespace: default
      labels:
        k8s-app: dgis-docker-hub
      annotations:
        deployment.kubernetes.io/revision: '1'
    spec:
      replicas: 1
      selector:
        matchLabels:
          k8s-app: dgis-docker-hub
      template:
        metadata:
          labels:
            k8s-app: dgis-docker-hub
        spec:
          containers:
            - name: registry
              image: registry:2.7.1
              ports:
                - containerPort: 5000
                  protocol: TCP
              env:
                - name: REGISTRY_HTTP_TLS_CERTIFICATE
                  value: "/registry-certs/tls.crt"
                - name: REGISTRY_HTTP_TLS_KEY
                  value: "/registry-certs/tls.key"
                - name: REGISTRY_AUTH
                  value: "htpasswd"
                - name: REGISTRY_AUTH_HTPASSWD_PATH
                  value: "/registry-certs/httppasswd"
                - name: REGISTRY_AUTH_HTPASSWD_REALM
                  value: "Registry Realm"
              volumeMounts:
              - name: dgis-docker-hub-data
                mountPath: /var/lib/registry
              - name: registry-certs
                mountPath: /registry-certs
          volumes:
            - name: dgis-docker-hub-data
              persistentVolumeClaim:
                claimName: dgis-docker-hub-data
            - name: registry-certs
              persistentVolumeClaim:
                claimName: registry-certs
    ~~~

  * 应用连接私有仓库只需要要加载创建的 secret 即可

    ~~~yaml
    kind: Deployment
    apiVersion: apps/v1
    metadata:
      name: dgis-datamanager-broker
      namespace: dgis-server
      labels:
        k8s-app: dgis-datamanager-broker
      annotations:
        deployment.kubernetes.io/revision: '1'
    spec:
      replicas: ${DGIS_DATAMANAGER_BROKER_REPLICAS}
      selector:
        matchLabels:
          k8s-app: dgis-datamanager-broker
      template:
        metadata:
          name: dgis-datamanager-broker
          creationTimestamp: null
          labels:
            k8s-app: dgis-datamanager-broker
        spec:
          volumes:
            - name: date-localtime-config
              hostPath:
                path: /etc/localtime
            - name: date-timezone-config
              hostPath:
                path: /etc/timezone
            - name: data-hosts
              hostPath:
                path: /etc/hosts
            - name: dgis
              persistentVolumeClaim:
                claimName: dgis
            - name: dgis-config
              configMap:
                name: dgis-configmap
                items:
                  - key: dgis.datamanager.broker.application.properties
                    path: dgis.datamanager.broker.application.properties
          imagePullSecrets:
            - name: regsecret
          containers:
            - name: dgis-datamanager-broker
              image: 'registry.dgisserver.com:5000/dgis-server/dgis-datamanager-broker:latest'
              env: 
                - name: SW_AGENT_COLLECTOR_BACKEND_SERVICES
                  value: "skywalking.monitoring:11800"
                - name: SW_AGENT_NAME
                  value: "dgis-datamanager-broker"
                - name: SW_AGENT_INSTANCE_NAME
                  valueFrom:
                    fieldRef:
                      fieldPath: metadata.name
                - name: JAVA_TOOL_OPTIONS
                  value: "-Xmx2688M -Xms2688M -Xmn960M -XX:MaxMetaspaceSize=512M -XX:MetaspaceSize=512M -XX:+UseConcMarkSweepGC -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=70 -XX:+ExplicitGCInvokesConcurrentAndUnloadsClasses -XX:+CMSClassUnloadingEnabled -XX:+ParallelRefProcEnabled -XX:+CMSScavengeBeforeRemark -XX:ParallelGCThreads=8"
              resources: {}
              volumeMounts:
                - name: date-localtime-config
                  mountPath: /etc/localtime
              lifecycle:
                preStop:
                  exec:
                    command: ["/bin/sh", "-c", "sleep 30"]
              terminationMessagePath: /dev/termination-log
              terminationMessagePolicy: File
              imagePullPolicy: Always
              securityContext:
                privileged: true
          restartPolicy: Always
          terminationGracePeriodSeconds: 30
          dnsPolicy: ClusterFirst
          securityContext: {}
          schedulerName: default-scheduler
    ~~~
    
    
  
  
